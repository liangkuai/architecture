# 限流

限流也就是流量控制。系统的处理能力有限，但是任意时间到来的请求是随机且不可控的，所以我们需要根据系统的处理能力对流量进行控制。


### 限流算法
服务中通常是根据「每秒处理的事务数」（TPS，Transaction Per Second）来衡量接口的流量。

常见的限流算法有，
- 固定窗口计数器；
- 滑动窗口计数器；
- 漏桶；
- 令牌桶。

#### 1. 固定窗口计数器算法
1. 将时间划分为多个窗口；
2. 在每个窗口内每有一次请求就将计数器加一；
3. 如果计数器超过了限制数量，那么本窗口内所有的请求都被丢弃；
4. 当时间到达下一个窗口时，计数器重置。

但是这个算法有时会导致通过的请求量是阈值的两倍。考虑如下情况：限制 1 秒内最多通过 5 个请求，在第一个窗口的最后半秒内通过了 5 个请求，第二个窗口的前半秒内又通过了 5 个请求。这样看来就是在 1 秒内通过了 10 个请求。

#### 2. 滑动窗口计数器算法
1. 维持一个窗口；
2. 窗口随着时间移动，「移动后窗口的已使用请求量」=「移动前窗口的已使用请求量」-「移动时间段内的请求量」；
3. 在每个窗口内每有一次请求就将计数器加一；

窗口划分越细，滑动越平滑，限流的统计越精确。

#### 3. 漏桶算法
1. 将每个请求看成“水滴”落入“漏桶”进行存储；
2. “漏桶”以固定速率向外“漏”出请求来执行；
3. 如果“漏桶”空了就停止“漏水”，如果“漏桶”满了就丢弃多余的“水滴”。

漏桶算法通常使用队列实现，服务的请求会存到队列中，服务的提供方就按照固定的速率从队列中取出请求并执行，过多的请求就放在队列中排队或直接拒绝。

漏桶算法的缺陷也很明显，当短时间内有大量的请求时，即便此时服务器没有任何负载，每个请求也都得在队列中等待一段时间才能被响应。

#### 4. 令牌桶算法
1. 令牌以固定速率生成；
2. 生成的令牌放入令牌桶中存放，如果令牌桶满了那么多余的令牌会直接丢弃；
3. 当请求到达时，会尝试从令牌桶中取令牌，取到了令牌的请求可以执行；如果桶空了，那么尝试取令牌的请求会被直接丢弃。

令牌桶算法既能够将所有的请求平均分布到时间区间内，又能接受服务器能够承受范围内的突发请求，因此是目前使用较为广泛的一种限流算法。




### 参考
- [一文详解微服务架构 - 古霜卡比](https://www.cnblogs.com/skabyy/p/11396571.html)
- [分布式服务限流实战，已经为你排好坑了](https://mp.weixin.qq.com/s/qb3rg_ZpcMcvyaIRsvc1fw)