# 拜占庭将军问题

### 二将军问题

> 一支白军被围困在一个山谷中，山谷的左右两侧是蓝军。困在山谷中的白军人数多于山谷两侧的任意一支蓝军，而少于两支蓝军的之和。若一支蓝军对白军单独发起进攻，则必败无疑；但若两支蓝军同时发起进攻，则可取胜。两只蓝军的总指挥位于山谷左侧，他希望两支蓝军同时发起进攻，这样就要把命令传到山谷右侧的蓝军，以告知发起进攻的具体时间。假设他们只能派遣士兵穿越白军所在的山谷（唯一的通信信道）来传递消息，那么在穿越山谷时，士兵有可能被俘虏。只有当送信士兵成功往返后，总指挥才能确认进攻计划。

那么问题来了，左侧蓝军中的总指挥不能确定是否按命令中约定的时间发起进攻？

因为如果派遣出去送信的士兵没有回来，可能有两种情况：
1. 命令还没送达就被俘虏了，这时候右侧蓝军根本不知道要何时进攻；
2. 命令送达，但返回途中被俘虏了，这时候右侧蓝军知道要何时进攻，但左侧蓝军不知道右侧蓝军是否知晓进攻时间。

类似的问题在计算机网络中普遍存在，例如：发送者给接受者发送一个 HTTP 请求，或者 MySQL 客户端向 MySQL 服务器发送一条插入语句，然后超时了没有得到响应。请问服务器是写入成功了还是失败了？答案是不确定，有以下几种情况：
1. 可能请求由于网络故障根本没有送到服务器，因此写入失败；
2. 可能服务器收到了，也写入成功了，但是向客户端发送响应前服务器宕机了；
3. 可能服务器收到了，也写入成功了，也向客户端发送了响应，但是由于网络故障未送到客户端。

**无论哪种场景，在客户端看来都是一样的结果：它发出的请求没有得到响应。为了确保服务端成功写入数据，客户端只能重发请求，直至接收到服务端的响应。**

二将军问题的存在使得消息的发送者往往要重复发送消息，直到收到接收者的确认才认为发送成功，但这往往又会导致消息的重复发送。例如：电商系统中订单模块调用支付模块扣款的时候，如果网络故障导致二将军问题出现，扣款请求重复发送，产生的重复扣款结果显然是不能被接受的。因此要保证一次事务中的扣款请求无论被发送多少次，接收方有且只执行一次扣款动作，这种保证机制叫做接收方的**幂等性**。


### 拜占庭将军问题

> 曾经的拜占庭国土辽阔，为了抵御来自各个方向的敌人，军队之间分隔很远，他们之间只能通过信使互相传递消息。一场新的战役即将爆发，有5支拜占庭军队要共同进退，5个将军都是平级的，他们要怎么达成一起进攻或者一起撤退的共识呢？

最简单的办法就是投票，每个将军都派出信使将自己的意见发给其他四个将军。对每个将军来说，算上自己的票数，如果进攻票超过2票就会发起进攻，如果少于或者等于2票就撤退。这是最简单的情况，很合逻辑。

但是如果出现以下情况：
1. 5个将军中有一个是奸细，其他4个将军有两个赞成进攻，2个反对，这个将军给其中2个发去了进攻的意见，给另外2个却是撤退，结果是2支军队进攻，2支军队撤退，没有达成共识。
2. 可能有一个或者多个信使被暗杀，或者被策反。

在这两种情况下，投票的结果不能代表大多数将军的意见。可以总结出拜占庭将军问题：在可能有叛徒的情况下，其余忠诚的将军如何不受其影响达成共识或者一致？



### 拜占庭将军问题与分布式系统
将拜占庭将军的故事映射到分布式系统上，每个将军代表一台计算机，信使代表通信系统，单台计算机可能遭受恶意攻击后向其他计算机发送错误信息，通信网络可能会阻塞、断开，通信内容可能被截取、替换，在这些情况下，正常运行的计算机怎么达成一致执行任务呢？




### 参考
- [如何理解拜占庭将军问题？ - 知乎](https://www.zhihu.com/question/23167269)