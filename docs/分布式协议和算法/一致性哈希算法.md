# 一致性哈希算法

我们在做分库分表或者分布式存储的时候，如何进行数据分片（sharding）? 为了能让数据均匀分布，最常见的方式就是 Hash 取模。

### Hash 取模
对于 N 个节点，对 key 进行 `index = hash(key) % N` 计算出存储节点。

但是这种方式的容错性和扩展性差，比如：删除或者新增一个节点时，对于新的 key 没什么问题，但是老的 key 就会出现映射错误。为了解决这个问题就得重新计算所有的 key，并重新分配，但是代价昂贵，可能对正在运行的系统产生影响。

除了重新分配所有 key，还有一种更好的方案就是「一致性哈希算法」。


### 一致性哈希算法
一致性哈希算法是将所有的哈希值构成了一个环，值的范围在 `0 ~ 2^32-1`。

1. 先将各个机器的 ip 或者主机名作为唯一 key，进行 `hash(key)`，计算出的 hash 值就是机器在环上的位置。
2. 对于存储的数据，同样对 key 进行 `hash(key)`，
    - 如果计算的 hash 值刚好是在某个机器上，那就直接存储；
    - 如果没有对应的机器，那就在哈希环上顺时针查找最近的机器，进行存储。

#### 1. 新增节点
只需要对新节点与前后两个相邻节点间的数据进行重新分配。

#### 2. 删除节点
被删除节点与其上一个节点间的数据会被重新分配到被删除节点的下一个节点。

#### 3. 虚拟节点
各个节点不是均匀分布的话，容易导致数据存储不均衡。

一致性哈希算法引入虚拟节点来解决这个问题。也就是将每台服务器虚拟为一组虚拟服务器，将虚拟服务器放到哈希环上，如果要确定服务器，需要先确定虚拟服务器，再由虚拟服务器确定物理机。


### 使用场景
- 分布式存储
- 负载均衡