# 分布式事务


### 本地事务（单数据源事务）
如果一个程序在一次业务流中通过连接驱动和数据源接口只连接并操作一个特定的数据库，该程序就可以利用数据库提供的事务机制（如果数据库支持事务的话）保证对库中记录所进行的操作的可靠性（ACID）。

这样的单数据源事务也叫做单机事务，或者**本地事务**。


### 分布式事务（多数据源事务）
在分布式场景下，一个系统由多个子系统构成，每个子系统有独立的数据源。多个子系统之间通过互相调用来组合出更复杂的业务。在微服务架构中，每一个子系统被称作一个微服务，同样每个微服务都维护自己的数据库，以保持独立性。

例如，一个电商系统可能由「购物服务」、「库存服务」、「订单服务」等组成。「购物服务」通过调用「库存服务」和「订单服务」来整合出购物业务。用户完成下单时，「购物服务」一方面调用「库存服务」扣减相应商品的库存数量，另一方面调用「订单服务」插入订单记录。（为了后文描述分布式事务解决方案的方便，这里给出的是一个最简单的电商系统服务划分和最简单的购物业务流程，后续的支付、物流等业务不在考虑范围内）

在用户购物的业务场景中，「购物服务」的业务涉及两个数据库：库存库（repo_db）和订单库（order_db），也就是「购物业务」是调用多数据源来组合而成的。作为一个面向消费者的系统，电商系统要保证购物业务的高度可靠性，这里的可靠性同样有 ACID 四种语义。

但是一个数据库的本地事务机制仅仅对落到自己本机的操作起作用，无法干涉对其他数据库的操作。所以，数据库自身提供的本地事务机制无法确保业务对多数据源全局操作的可靠性。

这样的多数据源事务就是**分布式事务**，也叫做全局事务；需要引入分布式事务机制来解决。


### 常见分布式事务解决方案
分布式事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于分布式系统的不同节点之上。通常一个分布式事务中会涉及对多个数据源或业务系统的操作。

#### 1. 分布式事务模型
描述分布式事务，常常会使用以下几个名词：

- 事务参与者：例如每个数据库就是一个事务参与者；
- 事务协调者：访问多个数据源的程序；
- 资源管理器（Resource Manager, RM）：通常与事务参与者同义；
- 事务管理器（Transaction Manager, TM）：通常与事务协调者同义。

在分布式事务模型中，一个 TM 管理多个 RM，即一个服务程序访问多个数据源；TM 是一个全局事务管理器，协调多个本地事务的进度，使其共同提交或回滚，最终达成一种全局的 ACID 特性。

#### 2. 二将军问题与幂等性
> 一支白军被围困在一个山谷中，山谷的左右两侧是蓝军。困在山谷中的白军人数多于山谷两侧的任意一支蓝军，而少于两支蓝军的之和。若一支蓝军对白军单独发起进攻，则必败无疑；但若两支蓝军同时发起进攻，则可取胜。两只蓝军的总指挥位于山谷左侧，他希望两支蓝军同时发起进攻，这样就要把命令传到山谷右侧的蓝军，以告知发起进攻的具体时间。假设他们只能派遣士兵穿越白军所在的山谷（唯一的通信信道）来传递消息，那么在穿越山谷时，士兵有可能被俘虏。只有当送信士兵成功往返后，总指挥才能确认进攻计划。

那么问题来了，左侧蓝军中的总指挥不能确定是否按命令中约定的时间发起进攻？

因为如果派遣出去送信的士兵没有回来，可能有两种情况：
1. 命令还没送达就被俘虏了，这时候右侧蓝军根本不知道要何时进攻；
2. 命令送达，但返回途中被俘虏了，这时候右侧蓝军知道要何时进攻，但左侧蓝军不知道右侧蓝军是否知晓进攻时间。

类似的问题在计算机网络中普遍存在，例如：发送者给接受者发送一个 HTTP 请求，或者 MySQL 客户端向 MySQL 服务器发送一条插入语句，然后超时了没有得到响应。请问服务器是写入成功了还是失败了？答案是不确定，有以下几种情况：
1. 可能请求由于网络故障根本没有送到服务器，因此写入失败；
2. 可能服务器收到了，也写入成功了，但是向客户端发送响应前服务器宕机了；
3. 可能服务器收到了，也写入成功了，也向客户端发送了响应，但是由于网络故障未送到客户端。

**无论哪种场景，在客户端看来都是一样的结果：它发出的请求没有得到响应。为了确保服务端成功写入数据，客户端只能重发请求，直至接收到服务端的响应。**

二将军问题的存在使得消息的发送者往往要重复发送消息，直到收到接收者的确认才认为发送成功，但这往往又会导致消息的重复发送。例如：电商系统中订单模块调用支付模块扣款的时候，如果网络故障导致二将军问题出现，扣款请求重复发送，产生的重复扣款结果显然是不能被接受的。因此要保证一次事务中的扣款请求无论被发送多少次，接收方有且只执行一次扣款动作，这种保证机制叫做接收方的**幂等性**。

#### 3. 分布式事务解决方案
- 2PC
- 3PC
- TCC
- 本地消息表
- 事务状态表方案
- 基于消息中间件的最终一致性事务方案
- Seata in AT mode


### 参考
- [1.4w字，25 张图让你彻底掌握分布式事务原理 - allentofight - GitBook](https://codesea.gitbook.io/allentofight/xi-tong-she-ji/1.4w-zi-25-zhang-tu-rang-ni-che-di-zhang-wo-fen-bu-shi-shi-wu-yuan-li)