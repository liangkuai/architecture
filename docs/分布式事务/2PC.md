# 2PC

Two-Phase Commit，二阶段提交。基于 XA 规范的实现。

**本质：牺牲一部分可用性来换取一致性，是一种强一致性方案。**

为了使基于分布式系统架构下的所有节点在进行事务处理过程中能够保持原子性和一致性而设计的一种算法。通常，二阶段提交协议也被认为是一种一致性协议，用来保证分布式系统数据的一致性。

目前，绝大部分的关系型数据库都是采用二阶段提交协议来完成分布式事务处理的，利用该协议能够非常方便的完成所有分布式事务参与者的协调，统一决定事务的提交或回滚，从而能够有效地保证分布式数据一致性，因此二阶段提交协议被广泛地应用在许多分布式系统中。


### 原理
2PC 引入一个事务协调者的角色来协调管理各个参与者的提交和回滚。二阶段指的是准备和提交两个阶段。

#### 第一阶段：准备
- 事务协调器要求每个涉及到事务的数据库预提交（precommit）此操作，并反映是否可以提交。
- 事务协调器同步等待所有数据库的响应，就进入第二阶段。

#### 第二阶段：提交
- 如果有任何一个数据库返回失败，那么所有数据库都会被要求回滚。
- 如果所有数据库都返回准备成功，那么事务协调器要求每个数据库提交事务，等待所有事务都提交成功之后，返回事务执行成功。

> 如果第二阶段，有数据库失败怎么办？
>
> - 如果第二阶段执行的是提交事务操作，那就不断重试，直到提交成功。
> - 如果第二阶段执行的是回滚事务操作，那也是不断重试，直到所有参与者回滚。

### 优点

尽量保证了数据的强一致性，适合对数据强一致性要求很高的关键领域。（其实也不能 100% 保证强一致）


### 缺点

#### 同步阻塞
2PC 是一个同步阻塞协议，第一个阶段中，事务协调者会等待所有参与者响应才会进行下一步操作（当然第一阶段的协调者有超时机制，假设因为网络原因没有收到某个参与者的响应或某个参与者挂了，那么超时后就会判断事务失败，向所有参与者发送回滚命令）

实现复杂，牺牲了可用性，对性能影响较大，不适合高并发的场景。    