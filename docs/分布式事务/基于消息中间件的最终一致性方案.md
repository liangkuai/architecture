# 基于消息中间件的最终一致性方案


### 过程

1. A 系统先向 MQ 发送一条 prepare 消息，
    - 如果 prepare 消息发送失败，就直接取消操作；
    - 如果消息发送成功，就执行本地事务。
2. 如果本地事务执行成功，就向 MQ 发送一条 confirm 消息，如果发送失败，就发送回滚消息；
3. B 系统定期消费 MQ 中的 confirm 消息，执行本地事务，并发送 ack 消息。
    - 如果 B 系统中的本地事务失败，会一直不断重试；
    - 如果是业务失败，会向 A 系统发起回滚请求。
4. MQ 会定期轮询所有 prepare 消息调用系统 A 提供的接口查询消息的处理情况，如果该 prepare 消息本地事务处理成功，则重新发送 confirm 消息，否则直接回滚该消息。

该方案与本地消息最大的不同是去掉了本地消息表，其次本地消息表依赖消息表重试写入 MQ，这一步由本方案中的轮询 prepare 消息状态来重试或者回滚该消息替代。其实现条件与容错方案基本一致。目前市面上实现该方案的只有阿里的 RocketMQ。